<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyRouter ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ¤– AnyRouter ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="text-gray-600">è‡ªåŠ¨åŒ–ç®¡ç†å¤šè´¦å·ç­¾åˆ°ï¼Œè½»æ¾è·å–æ¯æ—¥å¥–åŠ±</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">æ€»è´¦å·æ•°</div>
                <div class="text-3xl font-bold text-blue-600">{{ statistics.total_accounts }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">å·²å¯ç”¨è´¦å·</div>
                <div class="text-3xl font-bold text-green-600">{{ statistics.enabled_accounts }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">ä»Šæ—¥ç­¾åˆ°æˆåŠŸ</div>
                <div class="text-3xl font-bold text-purple-600">{{ statistics.today_checkin_success }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">æ€»ä½™é¢</div>
                <div class="text-3xl font-bold text-orange-600">${{ statistics.total_quota?.toFixed(2) || 0 }}</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex gap-4">
            <button @click="showAddAccountModal = true" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                â• æ·»åŠ è´¦å·
            </button>
            <button @click="checkinAll" :disabled="isCheckingIn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition disabled:opacity-50">
                {{ isCheckingIn ? 'ç­¾åˆ°ä¸­...' : 'ğŸ”„ å…¨éƒ¨ç­¾åˆ°' }}
            </button>
            <button @click="loadAccounts" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                ğŸ”ƒ åˆ·æ–°æ•°æ®
            </button>
        </div>

        <!-- è´¦å·åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">è´¦å·åˆ—è¡¨</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">ID</th>
                            <th class="text-left py-3 px-4">åç§°</th>
                            <th class="text-left py-3 px-4">ç”¨æˆ·å</th>
                            <th class="text-left py-3 px-4">å¹³å°</th>
                            <th class="text-left py-3 px-4">çŠ¶æ€</th>
                            <th class="text-left py-3 px-4">ä½™é¢</th>
                            <th class="text-left py-3 px-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="account in accounts" :key="account.id" class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">{{ account.id }}</td>
                            <td class="py-3 px-4 font-medium">{{ account.name }}</td>
                            <td class="py-3 px-4">{{ account.username }}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">{{ account.provider }}</span>
                            </td>
                            <td class="py-3 px-4">
                                <span :class="account.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                      class="px-2 py-1 rounded text-sm">
                                    {{ account.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨' }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <div v-if="account.balance" class="text-sm">
                                    <div class="font-medium text-green-600">ğŸ’° ${{ account.balance.quota }}</div>
                                    <div class="text-gray-500 text-xs">å·²ç”¨: ${{ account.balance.used_quota }}</div>
                                </div>
                                <div v-else class="text-gray-400 text-sm">--</div>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex gap-2">
                                    <button @click="checkinAccount(account.id)" class="text-green-600 hover:underline text-sm">
                                        ç­¾åˆ°
                                    </button>
                                    <button @click="editAccount(account)" class="text-blue-600 hover:underline text-sm">
                                        ç¼–è¾‘
                                    </button>
                                    <button @click="toggleAccount(account)" class="text-yellow-600 hover:underline text-sm">
                                        {{ account.enabled ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                    </button>
                                    <button @click="deleteAccount(account.id)" class="text-red-600 hover:underline text-sm">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="accounts.length === 0" class="text-center py-8 text-gray-500">
                    æš‚æ— è´¦å·ï¼Œè¯·ç‚¹å‡»"æ·»åŠ è´¦å·"æŒ‰é’®æ·»åŠ 
                </div>
            </div>
        </div>

        <!-- ç­¾åˆ°æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">ç­¾åˆ°æ—¥å¿—</h2>
            <div class="space-y-2 max-h-96 overflow-y-auto">
                <div v-for="log in logs" :key="log.id" class="p-3 border rounded flex justify-between items-center">
                    <div>
                        <span class="font-medium">{{ log.account_name }}</span>
                        <span :class="log.success ? 'text-green-600' : 'text-red-600'" class="ml-2">
                            {{ log.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' }}
                        </span>
                        <span v-if="log.message" class="text-gray-600 ml-2 text-sm">- {{ log.message }}</span>
                    </div>
                    <div class="text-sm text-gray-500">{{ formatDate(log.created_at) }}</div>
                </div>
                <div v-if="logs.length === 0" class="text-center py-8 text-gray-500">
                    æš‚æ— ç­¾åˆ°æ—¥å¿—
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘è´¦å·æ¨¡æ€æ¡† -->
        <div v-if="showAddAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold mb-4">{{ editingAccount ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ è´¦å·' }}</h3>
                <form @submit.prevent="saveAccount">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">è´¦å·åç§°</label>
                        <input v-model="accountForm.name" type="text" required
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="ä¾‹å¦‚ï¼šä¸»è´¦å·">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ç”¨æˆ·å/é‚®ç®±</label>
                        <input v-model="accountForm.username" type="text" required
                               :disabled="editingAccount !== null"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="your@email.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">å¯†ç </label>
                        <input v-model="accountForm.password" type="password" :required="!editingAccount"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               :placeholder="editingAccount ? 'ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹' : 'è¯·è¾“å…¥å¯†ç '">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">å¹³å°</label>
                        <select v-model="accountForm.provider"
                                class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="anyrouter">AnyRouter</option>
                            <option value="agentrouter">AgentRouter</option>
                        </select>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" @click="testLogin" :disabled="isTesting"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition disabled:opacity-50">
                            {{ isTesting ? 'æµ‹è¯•ä¸­...' : 'ğŸ§ª æµ‹è¯•ç™»å½•' }}
                        </button>
                        <button type="submit" :disabled="isSaving"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition disabled:opacity-50">
                            {{ isSaving ? 'ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜' }}
                        </button>
                        <button type="button" @click="closeModal"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æç¤ºæ¶ˆæ¯ -->
        <div v-if="message.show"
             :class="message.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
             class="fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            {{ message.text }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    accounts: [],
                    logs: [],
                    statistics: {},
                    showAddAccountModal: false,
                    editingAccount: null,
                    accountForm: {
                        name: '',
                        username: '',
                        password: '',
                        provider: 'anyrouter'
                    },
                    message: {
                        show: false,
                        text: '',
                        type: 'success'
                    },
                    isSaving: false,
                    isTesting: false,
                    isCheckingIn: false
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                async loadData() {
                    await Promise.all([
                        this.loadAccounts(),
                        this.loadLogs(),
                        this.loadStatistics()
                    ]);
                },
                async loadAccounts() {
                    try {
                        const response = await axios.get('/api/accounts');
                        this.accounts = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥', 'error');
                    }
                },
                async loadLogs() {
                    try {
                        const response = await axios.get('/api/logs?limit=50');
                        this.logs = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½æ—¥å¿—å¤±è´¥', 'error');
                    }
                },
                async loadStatistics() {
                    try {
                        const response = await axios.get('/api/statistics');
                        this.statistics = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', 'error');
                    }
                },
                async saveAccount() {
                    this.isSaving = true;
                    try {
                        if (this.editingAccount) {
                            // æ›´æ–°è´¦å·
                            const updateData = { name: this.accountForm.name };
                            if (this.accountForm.password) {
                                updateData.password = this.accountForm.password;
                            }
                            await axios.put(`/api/accounts/${this.editingAccount.id}`, updateData);
                            this.showMessage('è´¦å·æ›´æ–°æˆåŠŸ', 'success');
                        } else {
                            // æ·»åŠ è´¦å·
                            await axios.post('/api/accounts', this.accountForm);
                            this.showMessage('è´¦å·æ·»åŠ æˆåŠŸ', 'success');
                        }
                        this.closeModal();
                        this.loadData();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'æ“ä½œå¤±è´¥', 'error');
                    } finally {
                        this.isSaving = false;
                    }
                },
                async testLogin() {
                    if (!this.accountForm.username || !this.accountForm.password) {
                        this.showMessage('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error');
                        return;
                    }

                    // æç¤ºç”¨æˆ·å³å°†æ‰“å¼€æµè§ˆå™¨
                    if (!confirm('å°†æ‰“å¼€æµè§ˆå™¨çª—å£è¿›è¡Œç™»å½•æµ‹è¯•ï¼Œè¯·ç¨å€™\n\næ³¨æ„ï¼š\n1. æµè§ˆå™¨ä¼šè‡ªåŠ¨å¡«å†™è´¦å·å¯†ç \n2. è¯·ç­‰å¾…è‡ªåŠ¨ç™»å½•å®Œæˆ\n3. ä¸è¦å…³é—­æµè§ˆå™¨çª—å£\n4. æµ‹è¯•å®Œæˆåæµè§ˆå™¨ä¼šè‡ªåŠ¨å…³é—­\n\nç‚¹å‡»"ç¡®å®š"å¼€å§‹æµ‹è¯•')) {
                        return;
                    }

                    this.isTesting = true;
                    this.showMessage('æ­£åœ¨æ‰“å¼€æµè§ˆå™¨æµ‹è¯•ç™»å½•ï¼Œè¯·ç¨å€™...', 'success');

                    // æš‚æ—¶éšè—æ¨¡æ€æ¡†ï¼Œé¿å…æŒ¡ä½æµè§ˆå™¨
                    const originalDisplay = this.showAddAccountModal;
                    this.showAddAccountModal = false;

                    try {
                        const response = await axios.post('/api/test-login', {
                            username: this.accountForm.username,
                            password: this.accountForm.password
                        });
                        this.showAddAccountModal = originalDisplay;
                        this.showMessage('âœ… ç™»å½•æµ‹è¯•æˆåŠŸï¼è´¦å·å¯†ç æ­£ç¡®', 'success');
                    } catch (error) {
                        this.showAddAccountModal = originalDisplay;
                        this.showMessage('âŒ ' + (error.response?.data?.detail || 'ç™»å½•æµ‹è¯•å¤±è´¥'), 'error');
                    } finally {
                        this.isTesting = false;
                    }
                },
                async deleteAccount(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`/api/accounts/${id}`);
                        this.showMessage('è´¦å·åˆ é™¤æˆåŠŸ', 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('åˆ é™¤å¤±è´¥', 'error');
                    }
                },
                async toggleAccount(account) {
                    try {
                        await axios.put(`/api/accounts/${account.id}`, {
                            enabled: !account.enabled
                        });
                        this.showMessage(`è´¦å·å·²${account.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`, 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('æ“ä½œå¤±è´¥', 'error');
                    }
                },
                async checkinAccount(id) {
                    try {
                        const response = await axios.post(`/api/checkin/${id}`);
                        this.showMessage('ç­¾åˆ°æˆåŠŸï¼', 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'ç­¾åˆ°å¤±è´¥', 'error');
                    }
                },
                async checkinAll() {
                    if (!confirm('ç¡®å®šè¦å¯¹æ‰€æœ‰å¯ç”¨çš„è´¦å·è¿›è¡Œç­¾åˆ°å—ï¼Ÿ')) return;
                    this.isCheckingIn = true;
                    try {
                        const response = await axios.post('/api/checkin-all');
                        this.showMessage(response.data.message, 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('æ‰¹é‡ç­¾åˆ°å¤±è´¥', 'error');
                    } finally {
                        this.isCheckingIn = false;
                    }
                },
                editAccount(account) {
                    this.editingAccount = account;
                    this.accountForm = {
                        name: account.name,
                        username: account.username,
                        password: '',
                        provider: account.provider
                    };
                    this.showAddAccountModal = true;
                },
                closeModal() {
                    this.showAddAccountModal = false;
                    this.editingAccount = null;
                    this.accountForm = {
                        name: '',
                        username: '',
                        password: '',
                        provider: 'anyrouter'
                    };
                },
                async loadAccountBalance(id) {
                    try {
                        const response = await axios.get(`/api/accounts/${id}`);
                        const balance = response.data.data.balance;
                        if (balance) {
                            alert(`å½“å‰ä½™é¢: $${balance.quota}\nå·²ä½¿ç”¨: $${balance.used_quota}`);
                        } else {
                            alert('æš‚æ— ä½™é¢è®°å½•');
                        }
                    } catch (error) {
                        this.showMessage('åŠ è½½ä½™é¢å¤±è´¥', 'error');
                    }
                },
                showMessage(text, type = 'success') {
                    this.message = { show: true, text, type };
                    setTimeout(() => {
                        this.message.show = false;
                    }, 3000);
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
