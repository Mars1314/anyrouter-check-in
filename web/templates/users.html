<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - AnyRouter ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="bg-white shadow-md mb-6">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ¤– AnyRouter ç­¾åˆ°ç®¡ç†</h1>
                    <div class="flex gap-2">
                        <a href="/dashboard" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">è´¦å·ç®¡ç†</a>
                        <a href="/users" class="px-4 py-2 text-blue-600 bg-blue-50 rounded-lg font-medium">ç”¨æˆ·ç®¡ç†</a>
                        <a href="/settings" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">ç³»ç»Ÿè®¾ç½®</a>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">{{ currentUser?.display_name || currentUser?.username }}</div>
                        <div class="text-xs text-gray-400">ç®¡ç†å‘˜</div>
                    </div>
                    <button @click="logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-4">
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex gap-4">
                <button @click="showAddUserModal = true" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                    â• æ·»åŠ ç”¨æˆ·
                </button>
                <button @click="loadUsers" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                    ğŸ”ƒ åˆ·æ–°åˆ—è¡¨
                </button>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">ç”¨æˆ·åˆ—è¡¨</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">ID</th>
                                <th class="text-left py-3 px-4">ç”¨æˆ·å</th>
                                <th class="text-left py-3 px-4">æ˜¾ç¤ºåç§°</th>
                                <th class="text-left py-3 px-4">è§’è‰²</th>
                                <th class="text-left py-3 px-4">æœ‰æ•ˆæœŸ</th>
                                <th class="text-left py-3 px-4">çŠ¶æ€</th>
                                <th class="text-left py-3 px-4">åˆ›å»ºæ—¶é—´</th>
                                <th class="text-left py-3 px-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="user in users" :key="user.id" class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">{{ user.id }}</td>
                                <td class="py-3 px-4 font-medium">{{ user.username }}</td>
                                <td class="py-3 px-4">{{ user.display_name }}</td>
                                <td class="py-3 px-4">
                                    <span :class="user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'"
                                          class="px-2 py-1 rounded text-sm">
                                        {{ user.role === 'admin' ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ æ™®é€šç”¨æˆ·' }}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <span v-if="user.expire_date" :class="isExpired(user.expire_date) ? 'text-red-600' : 'text-gray-600'" class="text-sm">
                                        {{ user.expire_date }}
                                        <span v-if="isExpired(user.expire_date)" class="ml-1">â°å·²è¿‡æœŸ</span>
                                    </span>
                                    <span v-else class="text-gray-400 text-sm">æ°¸ä¹…æœ‰æ•ˆ</span>
                                </td>
                                <td class="py-3 px-4">
                                    <span :class="user.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          class="px-2 py-1 rounded text-sm">
                                        {{ user.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨' }}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-600">{{ formatDate(user.created_at) }}</td>
                                <td class="py-3 px-4">
                                    <div class="flex gap-2">
                                        <button @click="editUser(user)" class="text-blue-600 hover:underline text-sm">
                                            ç¼–è¾‘
                                        </button>
                                        <button @click="toggleUser(user)" class="text-yellow-600 hover:underline text-sm">
                                            {{ user.enabled ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                        </button>
                                        <button v-if="user.role !== 'admin'" @click="deleteUser(user.id)" class="text-red-600 hover:underline text-sm">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="users.length === 0" class="text-center py-8 text-gray-500">
                        æš‚æ— ç”¨æˆ·æ•°æ®
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
        <div v-if="showAddUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold mb-4">{{ editingUser ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·' }}</h3>

                <form @submit.prevent="saveUser">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">ç”¨æˆ·å</label>
                        <input v-model="userForm.username" type="text" required
                               :disabled="editingUser !== null"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                               placeholder="ç™»å½•ç”¨æˆ·å">
                        <p v-if="editingUser" class="text-xs text-gray-500 mt-1">ç”¨æˆ·åä¸å¯ä¿®æ”¹</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">æ˜¾ç¤ºåç§°</label>
                        <input v-model="userForm.display_name" type="text" required
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="æ˜¾ç¤ºåç§°">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">å¯†ç </label>
                        <input v-model="userForm.password" type="text" :required="!editingUser"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               :placeholder="editingUser ? 'ç•™ç©ºåˆ™ä¸ä¿®æ”¹' : 'è¯·è¾“å…¥å¯†ç '">
                        <p v-if="editingUser" class="text-xs text-gray-500 mt-1">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç </p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">è§’è‰²</label>
                        <select v-model="userForm.role"
                                class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">æœ‰æ•ˆæœŸ</label>
                        <input v-model="userForm.expire_date" type="date"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ">
                        <p class="text-xs text-gray-500 mt-1">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</p>
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" :disabled="isSaving"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition disabled:opacity-50">
                            {{ isSaving ? 'ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜' }}
                        </button>
                        <button type="button" @click="closeModal"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æç¤ºæ¶ˆæ¯ -->
        <div v-if="message.show"
             :class="message.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
             class="fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            {{ message.text }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // é…ç½® axios æ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨æ·»åŠ  token
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        // å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†401é”™è¯¯
        axios.interceptors.response.use(response => {
            return response;
        }, error => {
            if (error.response && error.response.status === 401) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            } else if (error.response && error.response.status === 403) {
                alert('æƒé™ä¸è¶³ï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢');
                window.location.href = '/dashboard';
            }
            return Promise.reject(error);
        });

        createApp({
            data() {
                return {
                    currentUser: null,
                    users: [],
                    showAddUserModal: false,
                    editingUser: null,
                    userForm: {
                        username: '',
                        display_name: '',
                        password: '',
                        role: 'user',
                        expire_date: ''
                    },
                    message: {
                        show: false,
                        text: '',
                        type: 'success'
                    },
                    isSaving: false
                }
            },
            mounted() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œç®¡ç†å‘˜æƒé™
                const token = localStorage.getItem('token');
                const userStr = localStorage.getItem('user');

                if (!token || !userStr) {
                    window.location.href = '/';
                    return;
                }

                this.currentUser = JSON.parse(userStr);

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                if (this.currentUser.role !== 'admin') {
                    alert('æƒé™ä¸è¶³ï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢');
                    window.location.href = '/dashboard';
                    return;
                }

                this.loadUsers();
            },
            methods: {
                logout() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/';
                },
                async loadUsers() {
                    try {
                        const response = await axios.get('/api/users');
                        this.users = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
                    }
                },
                async saveUser() {
                    this.isSaving = true;
                    try {
                        if (this.editingUser) {
                            // æ›´æ–°ç”¨æˆ·
                            const updateData = {
                                display_name: this.userForm.display_name,
                                role: this.userForm.role,
                                expire_date: this.userForm.expire_date || null
                            };

                            // åªåœ¨å¡«å†™äº†å¯†ç æ—¶æ‰æ›´æ–°
                            if (this.userForm.password) {
                                updateData.password = this.userForm.password;
                            }

                            await axios.put(`/api/users/${this.editingUser.id}`, updateData);
                            this.showMessage('ç”¨æˆ·æ›´æ–°æˆåŠŸ', 'success');
                        } else {
                            // æ·»åŠ ç”¨æˆ·
                            await axios.post('/api/users', {
                                username: this.userForm.username,
                                display_name: this.userForm.display_name,
                                password: this.userForm.password,
                                role: this.userForm.role,
                                expire_date: this.userForm.expire_date || null
                            });
                            this.showMessage('ç”¨æˆ·æ·»åŠ æˆåŠŸ', 'success');
                        }
                        this.closeModal();
                        this.loadUsers();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'æ“ä½œå¤±è´¥', 'error');
                    } finally {
                        this.isSaving = false;
                    }
                },
                async deleteUser(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿåˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰è´¦å·æ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
                    try {
                        await axios.delete(`/api/users/${id}`);
                        this.showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                        this.loadUsers();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'åˆ é™¤å¤±è´¥', 'error');
                    }
                },
                async toggleUser(user) {
                    try {
                        await axios.put(`/api/users/${user.id}`, {
                            enabled: !user.enabled
                        });
                        this.showMessage(`ç”¨æˆ·å·²${user.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`, 'success');
                        this.loadUsers();
                    } catch (error) {
                        this.showMessage('æ“ä½œå¤±è´¥', 'error');
                    }
                },
                editUser(user) {
                    this.editingUser = user;
                    this.userForm = {
                        username: user.username,
                        display_name: user.display_name,
                        password: '',
                        role: user.role,
                        expire_date: user.expire_date || ''
                    };
                    this.showAddUserModal = true;
                },
                closeModal() {
                    this.showAddUserModal = false;
                    this.editingUser = null;
                    this.userForm = {
                        username: '',
                        display_name: '',
                        password: '',
                        role: 'user',
                        expire_date: ''
                    };
                },
                isExpired(expireDate) {
                    if (!expireDate) return false;
                    const today = new Date().toISOString().split('T')[0];
                    return expireDate < today;
                },
                showMessage(text, type = 'success') {
                    this.message = { show: true, text, type };
                    setTimeout(() => {
                        this.message.show = false;
                    }, 3000);
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString + ' UTC');
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
