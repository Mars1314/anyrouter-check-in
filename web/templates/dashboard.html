<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyRouter ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="bg-white shadow-md mb-6">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ¤– AnyRouter ç­¾åˆ°ç®¡ç†</h1>
                    <div class="flex gap-2">
                        <a href="/dashboard" class="px-4 py-2 text-blue-600 bg-blue-50 rounded-lg font-medium">è´¦å·ç®¡ç†</a>
                        <a v-if="currentUser && currentUser.role === 'admin'" href="/users" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">ç”¨æˆ·ç®¡ç†</a>
                        <a v-if="currentUser && currentUser.role === 'admin'" href="/settings" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg">ç³»ç»Ÿè®¾ç½®</a>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">{{ currentUser?.display_name || currentUser?.username }}</div>
                        <div class="text-xs text-gray-400">{{ currentUser?.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}</div>
                    </div>
                    <button @click="logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-4">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">æ€»è´¦å·æ•°</div>
                    <div class="text-3xl font-bold text-blue-600">{{ statistics.total_accounts }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">å·²å¯ç”¨è´¦å·</div>
                    <div class="text-3xl font-bold text-green-600">{{ statistics.enabled_accounts }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">ä»Šæ—¥ç­¾åˆ°æˆåŠŸ</div>
                    <div class="text-3xl font-bold text-purple-600">{{ statistics.today_checkin_success }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-gray-500 text-sm">æ€»ä½™é¢</div>
                    <div class="text-3xl font-bold text-orange-600">${{ statistics.total_quota?.toFixed(2) || 0 }}</div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex gap-4">
                <button @click="showAddAccountModal = true" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                    â• æ·»åŠ è´¦å·
                </button>
                <button @click="checkinAll" :disabled="isCheckingIn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition disabled:opacity-50">
                    {{ isCheckingIn ? 'ç­¾åˆ°ä¸­...' : 'ğŸ”„ å…¨éƒ¨ç­¾åˆ°' }}
                </button>
                <button @click="loadAccounts" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition">
                    ğŸ”ƒ åˆ·æ–°æ•°æ®
                </button>
            </div>

        <!-- è´¦å·åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">è´¦å·åˆ—è¡¨</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">ID</th>
                            <th class="text-left py-3 px-4">åç§°</th>
                            <th class="text-left py-3 px-4">è®¤è¯æ–¹å¼</th>
                            <th class="text-left py-3 px-4">å¹³å°</th>
                            <th class="text-left py-3 px-4">çŠ¶æ€</th>
                            <th class="text-left py-3 px-4">ä½™é¢</th>
                            <th class="text-left py-3 px-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="account in accounts" :key="account.id" class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">{{ account.id }}</td>
                            <td class="py-3 px-4 font-medium">{{ account.name }}</td>
                            <td class="py-3 px-4">
                                <span :class="account.auth_type === 'password' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'"
                                      class="px-2 py-1 rounded text-sm">
                                    {{ account.auth_type === 'password' ? 'ğŸ”‘ å¯†ç ' : 'ğŸª Cookies' }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">{{ account.provider }}</span>
                            </td>
                            <td class="py-3 px-4">
                                <span :class="account.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                      class="px-2 py-1 rounded text-sm">
                                    {{ account.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨' }}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <div v-if="account.balance" class="text-sm">
                                    <div class="font-medium text-green-600">ğŸ’° ${{ account.balance.quota }}</div>
                                    <div class="text-gray-500 text-xs">å·²ç”¨: ${{ account.balance.used_quota }}</div>
                                </div>
                                <div v-else class="text-gray-400 text-sm">--</div>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex gap-2">
                                    <button @click="checkinAccount(account.id)" class="text-green-600 hover:underline text-sm">
                                        ç­¾åˆ°
                                    </button>
                                    <button @click="viewCredentials(account)" class="text-purple-600 hover:underline text-sm">
                                        æŸ¥çœ‹å‡­æ®
                                    </button>
                                    <button @click="editAccount(account)" class="text-blue-600 hover:underline text-sm">
                                        ç¼–è¾‘
                                    </button>
                                    <button @click="toggleAccount(account)" class="text-yellow-600 hover:underline text-sm">
                                        {{ account.enabled ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                    </button>
                                    <button @click="deleteAccount(account.id)" class="text-red-600 hover:underline text-sm">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="accounts.length === 0" class="text-center py-8 text-gray-500">
                    æš‚æ— è´¦å·ï¼Œè¯·ç‚¹å‡»"æ·»åŠ è´¦å·"æŒ‰é’®æ·»åŠ 
                </div>
            </div>
        </div>

        <!-- ç­¾åˆ°æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">ç­¾åˆ°æ—¥å¿—</h2>
            <div class="space-y-2 max-h-96 overflow-y-auto">
                <div v-for="log in logs" :key="log.id" class="p-3 border rounded flex justify-between items-center">
                    <div>
                        <span class="font-medium">{{ log.account_name }}</span>
                        <span :class="log.success ? 'text-green-600' : 'text-red-600'" class="ml-2">
                            {{ log.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' }}
                        </span>
                        <span v-if="log.message" class="text-gray-600 ml-2 text-sm">- {{ log.message }}</span>
                    </div>
                    <div class="text-sm text-gray-500">{{ formatDate(log.created_at) }}</div>
                </div>
                <div v-if="logs.length === 0" class="text-center py-8 text-gray-500">
                    æš‚æ— ç­¾åˆ°æ—¥å¿—
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘è´¦å·æ¨¡æ€æ¡† -->
        <div v-if="showAddAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">{{ editingAccount ? 'ç¼–è¾‘è´¦å·' : 'æ·»åŠ è´¦å·' }}</h3>

                <!-- è®¤è¯æ–¹å¼é€‰æ‹©ï¼ˆä»…æ–°å¢æ—¶æ˜¾ç¤ºï¼‰ -->
                <div v-if="!editingAccount" class="mb-4">
                    <label class="block text-gray-700 mb-2">è®¤è¯æ–¹å¼</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" v-model="authType" value="password" class="mr-2">
                            <span>ç”¨æˆ·åå¯†ç </span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" v-model="authType" value="cookies" class="mr-2">
                            <span>Cookies + API User</span>
                        </label>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">
                        {{ authType === 'password' ? 'æ¨èï¼šè‡ªåŠ¨ç™»å½•ï¼Œæ›´æ–¹ä¾¿' : 'æ‰‹åŠ¨è·å–ï¼Œé€‚åˆæ— æ³•æä¾›å¯†ç çš„æƒ…å†µ' }}
                    </p>
                </div>

                <!-- ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºå½“å‰è®¤è¯ç±»å‹ -->
                <div v-if="editingAccount" class="mb-4 p-3 bg-gray-100 rounded">
                    <span class="text-sm text-gray-600">è®¤è¯æ–¹å¼ï¼š</span>
                    <span :class="authType === 'password' ? 'text-blue-600' : 'text-purple-600'" class="font-medium">
                        {{ authType === 'password' ? 'ğŸ”‘ å¯†ç è®¤è¯' : 'ğŸª Cookies è®¤è¯' }}
                    </span>
                </div>

                <form @submit.prevent="saveAccount">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">è´¦å·åç§°</label>
                        <input v-model="accountForm.name" type="text" required
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="ä¾‹å¦‚ï¼šä¸»è´¦å·">
                    </div>

                    <!-- ç”¨æˆ·åå¯†ç æ¨¡å¼ -->
                    <template v-if="authType === 'password'">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">ç”¨æˆ·å/é‚®ç®±</label>
                            <input v-model="accountForm.username" type="text" :required="!editingAccount"
                                   :disabled="editingAccount !== null"
                                   class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                                   :placeholder="editingAccount ? accountForm.username : 'your@email.com'">
                            <p v-if="editingAccount" class="text-xs text-gray-500 mt-1">ç”¨æˆ·åä¸å¯ä¿®æ”¹</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">å¯†ç </label>
                            <input v-model="accountForm.password" type="text" :required="!editingAccount"
                                   class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :placeholder="editingAccount ? 'ä¿®æ”¹å¯†ç ' : 'è¯·è¾“å…¥å¯†ç '">
                            <p v-if="editingAccount" class="text-xs text-gray-500 mt-1">å½“å‰å¯†ç å·²æ˜¾ç¤ºï¼Œå¯ç›´æ¥ä¿®æ”¹</p>
                        </div>
                    </template>

                    <!-- Cookies æ¨¡å¼ -->
                    <template v-if="authType === 'cookies'">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Cookies (JSONæ ¼å¼)</label>
                            <textarea v-model="accountForm.cookies" :required="!editingAccount" rows="4"
                                      class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      :placeholder="editingAccount ? 'ä¿®æ”¹ Cookies' : '{&quot;session&quot;: &quot;your-session-cookie&quot;}'"></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                {{ editingAccount ? 'å½“å‰ Cookies å·²æ˜¾ç¤ºï¼Œå¯ç›´æ¥ä¿®æ”¹' : 'ç²˜è´´ä»æµè§ˆå™¨å¤åˆ¶çš„ cookies JSON' }}
                            </p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">API User</label>
                            <input v-model="accountForm.api_user" type="text" :required="!editingAccount"
                                   class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :placeholder="editingAccount ? 'ä¿®æ”¹ API User' : 'ä»æµè§ˆå™¨è¯·æ±‚å¤´ä¸­è·å–'">
                            <p class="text-xs text-gray-500 mt-1">
                                {{ editingAccount ? 'å½“å‰ API User å·²æ˜¾ç¤ºï¼Œå¯ç›´æ¥ä¿®æ”¹' : 'åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network è¯·æ±‚å¤´ä¸­æŸ¥æ‰¾ new-api-user' }}
                            </p>
                        </div>
                    </template>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">å¹³å°</label>
                        <select v-model="accountForm.provider"
                                class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="anyrouter">AnyRouter</option>
                            <option value="agentrouter">AgentRouter</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">é€šçŸ¥é‚®ç®± (å¯é€‰)</label>
                        <input v-model="accountForm.email" type="email"
                               class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="user@example.com">
                        <p class="text-xs text-gray-500 mt-1">
                            å¡«å†™åï¼Œæ¯æ¬¡ç­¾åˆ°éƒ½ä¼šå‘é€é‚®ä»¶é€šçŸ¥åˆ°æ­¤åœ°å€ï¼ˆéœ€ç®¡ç†å‘˜é…ç½®å¥½é‚®ä»¶æœåŠ¡å™¨ï¼‰
                        </p>
                    </div>
                    <div class="flex gap-4">
                        <button v-if="authType === 'password' && !editingAccount" type="button" @click="testLogin" :disabled="isTesting"
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition disabled:opacity-50">
                            {{ isTesting ? 'æµ‹è¯•ä¸­...' : 'ğŸ§ª æµ‹è¯•ç™»å½•' }}
                        </button>
                        <button type="submit" :disabled="isSaving"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition disabled:opacity-50">
                            {{ isSaving ? 'ä¿å­˜ä¸­...' : 'ğŸ’¾ ä¿å­˜' }}
                        </button>
                        <button type="button" @click="closeModal"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æŸ¥çœ‹å‡­æ®æ¨¡æ€æ¡† -->
        <div v-if="showCredentialsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">è´¦å·å‡­æ®ä¿¡æ¯</h3>

                <div class="space-y-4">
                    <div class="p-3 bg-gray-100 rounded">
                        <div class="text-sm text-gray-600 mb-1">è´¦å·åç§°</div>
                        <div class="font-medium">{{ credentialsData.name }}</div>
                    </div>

                    <div class="p-3 bg-gray-100 rounded">
                        <div class="text-sm text-gray-600 mb-1">è®¤è¯æ–¹å¼</div>
                        <div class="font-medium">
                            <span :class="credentialsData.auth_type === 'password' ? 'text-blue-600' : 'text-purple-600'">
                                {{ credentialsData.auth_type === 'password' ? 'ğŸ”‘ å¯†ç è®¤è¯' : 'ğŸª Cookies è®¤è¯' }}
                            </span>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-100 rounded">
                        <div class="text-sm text-gray-600 mb-1">å¹³å°</div>
                        <div class="font-medium">{{ credentialsData.provider }}</div>
                    </div>

                    <div v-if="credentialsData.username" class="p-3 bg-gray-100 rounded">
                        <div class="text-sm text-gray-600 mb-1">ç”¨æˆ·å</div>
                        <div class="font-medium font-mono">{{ credentialsData.username }}</div>
                    </div>

                    <div v-if="credentialsData.api_user" class="p-3 bg-blue-50 rounded border border-blue-200">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-sm font-semibold text-gray-700">API User (æ˜æ–‡)</div>
                            <button @click="copyToClipboard(credentialsData.api_user, 'API User')"
                                    class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                        <div class="font-mono text-sm bg-white p-3 rounded break-all border border-blue-100">
                            {{ credentialsData.api_user }}
                        </div>
                    </div>

                    <div v-if="credentialsData.cookies" class="p-3 bg-purple-50 rounded border border-purple-200">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-sm font-semibold text-gray-700">Cookies (JSON æ˜æ–‡)</div>
                            <button @click="copyToClipboard(credentialsData.cookies, 'Cookies')"
                                    class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                        </div>
                        <div class="font-mono text-xs bg-white p-3 rounded break-all max-h-64 overflow-y-auto border border-purple-100 whitespace-pre-wrap">{{ formatCookiesDisplay(credentialsData.cookies) }}</div>
                    </div>

                    <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
                        <div class="text-xs text-yellow-800">
                            âš ï¸ è¿™äº›å‡­æ®ä¿¡æ¯éå¸¸æ•æ„Ÿï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ç»™ä»–äºº
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button @click="showCredentialsModal = false"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- æç¤ºæ¶ˆæ¯ -->
        <div v-if="message.show"
             :class="message.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
             class="fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            {{ message.text }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // é…ç½® axios æ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨æ·»åŠ  token
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        }, error => {
            return Promise.reject(error);
        });

        // å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†401é”™è¯¯
        axios.interceptors.response.use(response => {
            return response;
        }, error => {
            if (error.response && error.response.status === 401) {
                // Token è¿‡æœŸæˆ–æ— æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
            return Promise.reject(error);
        });

        createApp({
            data() {
                return {
                    currentUser: null,  // å½“å‰ç™»å½•ç”¨æˆ·
                    accounts: [],
                    logs: [],
                    statistics: {},
                    showAddAccountModal: false,
                    showCredentialsModal: false,
                    credentialsData: {},
                    editingAccount: null,
                    authType: 'password', // 'password' æˆ– 'cookies'
                    accountForm: {
                        name: '',
                        username: '',
                        password: '',
                        cookies: '',
                        api_user: '',
                        provider: 'anyrouter',
                        email: ''
                    },
                    message: {
                        show: false,
                        text: '',
                        type: 'success'
                    },
                    isSaving: false,
                    isTesting: false,
                    isCheckingIn: false
                }
            },
            mounted() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const token = localStorage.getItem('token');
                const userStr = localStorage.getItem('user');

                if (!token || !userStr) {
                    window.location.href = '/';
                    return;
                }

                this.currentUser = JSON.parse(userStr);
                this.loadData();
            },
            methods: {
                logout() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/';
                },
                async loadData() {
                    await Promise.all([
                        this.loadAccounts(),
                        this.loadLogs(),
                        this.loadStatistics()
                    ]);
                },
                async loadAccounts() {
                    try {
                        const response = await axios.get('/api/accounts');
                        this.accounts = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥', 'error');
                    }
                },
                async loadLogs() {
                    try {
                        const response = await axios.get('/api/logs?limit=50');
                        this.logs = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½æ—¥å¿—å¤±è´¥', 'error');
                    }
                },
                async loadStatistics() {
                    try {
                        const response = await axios.get('/api/statistics');
                        this.statistics = response.data.data;
                    } catch (error) {
                        this.showMessage('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', 'error');
                    }
                },
                async saveAccount() {
                    this.isSaving = true;
                    try {
                        if (this.editingAccount) {
                            // æ›´æ–°è´¦å·
                            const updateData = {
                                name: this.accountForm.name,
                                provider: this.accountForm.provider
                            };

                            // æ›´æ–°é‚®ç®±ï¼ˆå¯é€‰å­—æ®µï¼‰
                            if (this.accountForm.email !== undefined) {
                                updateData.email = this.accountForm.email || null;
                            }

                            if (this.authType === 'password') {
                                // å¯†ç è®¤è¯ï¼šæ›´æ–°å¯†ç ï¼ˆç¼–è¾‘æ—¶å¿…å¡«ï¼‰
                                if (this.accountForm.password) {
                                    updateData.password = this.accountForm.password;
                                }
                            } else {
                                // Cookies è®¤è¯ï¼šæ›´æ–° cookies å’Œ api_userï¼ˆç¼–è¾‘æ—¶å¿…å¡«ï¼‰
                                if (this.accountForm.cookies) {
                                    try {
                                        JSON.parse(this.accountForm.cookies);
                                        updateData.cookies = this.accountForm.cookies;
                                    } catch (e) {
                                        this.showMessage('Cookies æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„ JSON', 'error');
                                        this.isSaving = false;
                                        return;
                                    }
                                }
                                if (this.accountForm.api_user) {
                                    updateData.api_user = this.accountForm.api_user;
                                }
                            }

                            await axios.put(`/api/accounts/${this.editingAccount.id}`, updateData);
                            this.showMessage('è´¦å·æ›´æ–°æˆåŠŸ', 'success');
                        } else {
                            // æ·»åŠ è´¦å· - æ ¹æ®è®¤è¯ç±»å‹å‘é€ä¸åŒæ•°æ®
                            const accountData = {
                                name: this.accountForm.name,
                                provider: this.accountForm.provider
                            };

                            // æ·»åŠ é‚®ç®±ï¼ˆå¯é€‰ï¼‰
                            if (this.accountForm.email) {
                                accountData.email = this.accountForm.email;
                            }

                            if (this.authType === 'password') {
                                accountData.username = this.accountForm.username;
                                accountData.password = this.accountForm.password;
                            } else {
                                // éªŒè¯ cookies æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
                                try {
                                    JSON.parse(this.accountForm.cookies);
                                } catch (e) {
                                    this.showMessage('Cookies æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„ JSON', 'error');
                                    this.isSaving = false;
                                    return;
                                }
                                accountData.cookies = this.accountForm.cookies;
                                accountData.api_user = this.accountForm.api_user;
                            }

                            await axios.post('/api/accounts', accountData);
                            this.showMessage('è´¦å·æ·»åŠ æˆåŠŸ', 'success');
                        }
                        this.closeModal();
                        this.loadData();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'æ“ä½œå¤±è´¥', 'error');
                    } finally {
                        this.isSaving = false;
                    }
                },
                async testLogin() {
                    if (!this.accountForm.username || !this.accountForm.password) {
                        this.showMessage('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error');
                        return;
                    }

                    // æç¤ºç”¨æˆ·å³å°†æ‰“å¼€æµè§ˆå™¨
                    if (!confirm('å°†æ‰“å¼€æµè§ˆå™¨çª—å£è¿›è¡Œç™»å½•æµ‹è¯•ï¼Œè¯·ç¨å€™\n\næ³¨æ„ï¼š\n1. æµè§ˆå™¨ä¼šè‡ªåŠ¨å¡«å†™è´¦å·å¯†ç \n2. è¯·ç­‰å¾…è‡ªåŠ¨ç™»å½•å®Œæˆ\n3. ä¸è¦å…³é—­æµè§ˆå™¨çª—å£\n4. æµ‹è¯•å®Œæˆåæµè§ˆå™¨ä¼šè‡ªåŠ¨å…³é—­\n\nç‚¹å‡»"ç¡®å®š"å¼€å§‹æµ‹è¯•')) {
                        return;
                    }

                    this.isTesting = true;
                    this.showMessage('æ­£åœ¨æ‰“å¼€æµè§ˆå™¨æµ‹è¯•ç™»å½•ï¼Œè¯·ç¨å€™...', 'success');

                    // æš‚æ—¶éšè—æ¨¡æ€æ¡†ï¼Œé¿å…æŒ¡ä½æµè§ˆå™¨
                    const originalDisplay = this.showAddAccountModal;
                    this.showAddAccountModal = false;

                    try {
                        const response = await axios.post('/api/test-login', {
                            username: this.accountForm.username,
                            password: this.accountForm.password
                        });
                        this.showAddAccountModal = originalDisplay;
                        this.showMessage('âœ… ç™»å½•æµ‹è¯•æˆåŠŸï¼è´¦å·å¯†ç æ­£ç¡®', 'success');
                    } catch (error) {
                        this.showAddAccountModal = originalDisplay;
                        this.showMessage('âŒ ' + (error.response?.data?.detail || 'ç™»å½•æµ‹è¯•å¤±è´¥'), 'error');
                    } finally {
                        this.isTesting = false;
                    }
                },
                async deleteAccount(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`/api/accounts/${id}`);
                        this.showMessage('è´¦å·åˆ é™¤æˆåŠŸ', 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('åˆ é™¤å¤±è´¥', 'error');
                    }
                },
                async toggleAccount(account) {
                    try {
                        await axios.put(`/api/accounts/${account.id}`, {
                            enabled: !account.enabled
                        });
                        this.showMessage(`è´¦å·å·²${account.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}`, 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('æ“ä½œå¤±è´¥', 'error');
                    }
                },
                async checkinAccount(id) {
                    try {
                        const response = await axios.post(`/api/checkin/${id}`);
                        this.showMessage('ç­¾åˆ°æˆåŠŸï¼', 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage(error.response?.data?.detail || 'ç­¾åˆ°å¤±è´¥', 'error');
                    }
                },
                async checkinAll() {
                    if (!confirm('ç¡®å®šè¦å¯¹æ‰€æœ‰å¯ç”¨çš„è´¦å·è¿›è¡Œç­¾åˆ°å—ï¼Ÿ')) return;
                    this.isCheckingIn = true;
                    try {
                        const response = await axios.post('/api/checkin-all');
                        this.showMessage(response.data.message, 'success');
                        this.loadData();
                    } catch (error) {
                        this.showMessage('æ‰¹é‡ç­¾åˆ°å¤±è´¥', 'error');
                    } finally {
                        this.isCheckingIn = false;
                    }
                },
                async editAccount(account) {
                    try {
                        // è·å–è´¦å·å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«æ•æ„Ÿæ•°æ®ï¼‰
                        const response = await axios.get(`/api/accounts/${account.id}?include_sensitive=true`);
                        const fullAccount = response.data.data.account;

                        this.editingAccount = fullAccount;
                        this.authType = fullAccount.auth_type || 'password';
                        this.accountForm = {
                            name: fullAccount.name,
                            username: fullAccount.username || '',
                            password: fullAccount.password || '',
                            cookies: fullAccount.cookies || '',
                            api_user: fullAccount.api_user || '',
                            provider: fullAccount.provider,
                            email: fullAccount.email || ''
                        };
                        this.showAddAccountModal = true;
                    } catch (error) {
                        this.showMessage('åŠ è½½è´¦å·ä¿¡æ¯å¤±è´¥', 'error');
                    }
                },
                async viewCredentials(account) {
                    try {
                        // è·å–è´¦å·å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«æ•æ„Ÿæ•°æ®ï¼‰
                        const response = await axios.get(`/api/accounts/${account.id}?include_sensitive=true`);
                        const fullAccount = response.data.data.account;

                        this.credentialsData = {
                            name: fullAccount.name,
                            auth_type: fullAccount.auth_type || 'password',
                            provider: fullAccount.provider,
                            username: fullAccount.username || '',
                            api_user: fullAccount.api_user || '',
                            cookies: fullAccount.cookies || ''
                        };
                        this.showCredentialsModal = true;
                    } catch (error) {
                        this.showMessage('åŠ è½½å‡­æ®ä¿¡æ¯å¤±è´¥', 'error');
                    }
                },
                copyToClipboard(text, label) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).then(() => {
                            this.showMessage(`${label} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
                        }).catch(() => {
                            this.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                        });
                    } else {
                        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ textarea
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            this.showMessage(`${label} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
                        } catch (err) {
                            this.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                        }
                        document.body.removeChild(textarea);
                    }
                },
                closeModal() {
                    this.showAddAccountModal = false;
                    this.editingAccount = null;
                    this.authType = 'password';
                    this.accountForm = {
                        name: '',
                        username: '',
                        password: '',
                        cookies: '',
                        api_user: '',
                        provider: 'anyrouter',
                        email: ''
                    };
                },
                async loadAccountBalance(id) {
                    try {
                        const response = await axios.get(`/api/accounts/${id}`);
                        const balance = response.data.data.balance;
                        if (balance) {
                            alert(`å½“å‰ä½™é¢: $${balance.quota}\nå·²ä½¿ç”¨: $${balance.used_quota}`);
                        } else {
                            alert('æš‚æ— ä½™é¢è®°å½•');
                        }
                    } catch (error) {
                        this.showMessage('åŠ è½½ä½™é¢å¤±è´¥', 'error');
                    }
                },
                showMessage(text, type = 'success') {
                    this.message = { show: true, text, type };
                    setTimeout(() => {
                        this.message.show = false;
                    }, 3000);
                },
                formatCookiesDisplay(cookies) {
                    if (!cookies) return '';
                    try {
                        // å°è¯•è§£æä¸º JSON å¹¶æ ¼å¼åŒ–
                        const parsed = typeof cookies === 'string' ? JSON.parse(cookies) : cookies;
                        return JSON.stringify(parsed, null, 2);
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œç›´æ¥è¿”å›åŸæ–‡
                        return cookies;
                    }
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    // SQLite è¿”å›çš„æ˜¯ UTC æ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
                    const date = new Date(dateString + ' UTC');
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
